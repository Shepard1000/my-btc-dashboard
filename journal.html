<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BTCUSD Trade Journal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; background:#0f172a; color:#e5e7eb; margin:0; }
    .wrap { max-width:1200px; margin:20px auto; padding:0 16px; }
    h1 { font-size:22px; margin-bottom:16px; }
    .card { background:#111827; border:1px solid #334155; border-radius:10px; padding:16px; margin-bottom:20px; }
    label { font-size:13px; color:#9ca3af; margin-bottom:6px; display:block; }
    input, select, button { width:100%; padding:8px; border-radius:8px; border:1px solid #334155; background:#0b1222; color:#e5e7eb; }
    button { background:#2563eb; border:none; cursor:pointer; font-weight:600; }
    button:hover { filter:brightness(1.1); }
    table { width:100%; border-collapse:collapse; margin-top:10px; }
    th, td { border-bottom:1px solid #334155; padding:8px; text-align:center; }
    th { background:#0b1222; color:#9ca3af; }
    .filters { display:flex; gap:12px; margin-bottom:12px; flex-wrap:wrap; }
    .kpis { display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px; margin-top:10px; }
    .kpi { background:#0b1222; border:1px solid #334155; border-radius:10px; padding:10px; text-align:center; }
    .kpi .label { font-size:12px; color:#9ca3af; }
    .kpi .val { font-size:18px; font-weight:700; margin-top:6px; }
    #charts { display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BTCUSD Trade Journal</h1>

    <!-- Trade entry form -->
    <div class="card">
      <form id="tradeForm">
        <div class="filters">
          <div><label>Date</label><input type="date" id="date" required></div>
          <div><label>Setup</label><input type="text" id="setup" placeholder="Breakout/VWAP" required></div>
          <div><label>Session</label>
            <select id="session" required>
              <option value="">Select</option>
              <option>Asia</option><option>London</option><option>NY</option>
            </select>
          </div>
          <div><label>Conviction (1-5)</label><input type="number" id="conviction" min="1" max="5" required></div>
          <div><label>Size (USD)</label><input type="number" id="size" step="0.01" required></div>
          <div><label>Entry</label><input type="number" id="entry" step="0.01" required></div>
          <div><label>Exit</label><input type="number" id="exit" step="0.01" required></div>
          <div><label>Result</label>
            <select id="result" required>
              <option value="">Select</option>
              <option value="Win">Win</option>
              <option value="Loss">Loss</option>
            </select>
          </div>
        </div>
        <button type="submit">Add Trade</button>
        <div id="status"></div>
      </form>
    </div>

    <!-- Filters -->
    <div class="card">
      <div class="filters">
        <div><label>Filter by Setup</label><input type="text" id="filterSetup"></div>
        <div><label>Filter by Session</label>
          <select id="filterSession">
            <option value="">All</option><option>Asia</option><option>London</option><option>NY</option>
          </select>
        </div>
        <div><label>Date From</label><input type="date" id="filterFrom"></div>
        <div><label>Date To</label><input type="date" id="filterTo"></div>
        <button id="applyFilters" type="button">Apply Filters</button>
        <button id="exportBtn" type="button">Export CSV</button>
      </div>
    </div>

    <!-- KPIs -->
    <div class="card">
      <div class="kpis">
        <div class="kpi"><div class="label">Total trades</div><div class="val" id="kpiTotal">0</div></div>
        <div class="kpi"><div class="label">Win rate</div><div class="val" id="kpiWinRate">0%</div></div>
        <div class="kpi"><div class="label">Expectancy</div><div class="val" id="kpiExpectancy">0</div></div>
        <div class="kpi"><div class="label">Payoff ratio</div><div class="val" id="kpiPayoff">0</div></div>
        <div class="kpi"><div class="label">Longest streak</div><div class="val" id="kpiStreak">0</div></div>
      </div>
    </div>

    <!-- Trades table -->
    <div class="card">
      <table id="journalTable">
        <thead>
          <tr><th>Date</th><th>Setup</th><th>Session</th><th>Conviction</th><th>Size</th><th>Entry</th><th>Exit</th><th>Result</th><th>PnL</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Charts -->
    <div id="charts">
      <div class="card"><div id="equityChart"></div></div>
      <div class="card"><div id="distChart"></div></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://dgvvaxdzzbgjllfxmmrz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRndnZheGR6emJnamxsZnhtbXJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODAzNTcsImV4cCI6MjA3ODM1NjM1N30.pegoF2QFHc8LfIkRXWvQGLvNKzWLH8TK17T7SoJmmlY";
    const TRADES_URL = `${SUPABASE_URL}/rest/v1/trades`;
    const headers = { "Content-Type":"application/json","apikey":SUPABASE_ANON_KEY,"Authorization":`Bearer ${SUPABASE_ANON_KEY}`,"Prefer":"return=representation" };

    const form = document.getElementById("tradeForm");
    const statusEl = document.getElementById("status");
    const tableBody = document.querySelector("#journalTable tbody");

    async function loadTrades(filters={}) {
      let query = "?select=*&order=inserted_at.asc";
      if (filters.setup) query += `&setup=eq.${filters.setup}`;
      if (filters.session) query += `&session=eq.${filters.session}`;
      if (filters.from) query += `&trade_date=gte.${filters.from}`;
      if (filters.to) query += `&trade_date=lte.${filters.to}`;
      const res = await fetch(TRADES_URL+query,{headers});
      const rows = await res.json();
      renderTable(rows);
      computeKpis(rows);
      renderCharts(rows);
    }

    function renderTable(rows){
      tableBody.innerHTML="";
      if(!rows.length){tableBody.innerHTML="<tr><td colspan=9>No trades</td></tr>";return;}
      rows.forEach(r=>{
        const pnl=(r.exit-r.entry)*r.size/ r.entry; // approximate P
