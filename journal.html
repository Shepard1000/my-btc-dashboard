<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>BTCUSD Trade Journal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #111827;
      --text: #e5e7eb;
      --muted: #9ca3af;
      --accent: #22c55e;
      --danger: #ef4444;
      --border: #334155;
      --table-alt: #0b1222;
    }
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: var(--bg); color: var(--text); }
    .wrap { max-width: 980px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 22px; margin: 8px 0 16px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    @media (min-width: 900px) { .grid { grid-template-columns: 1fr 2fr; } }
    label { font-size: 13px; color: var(--muted); margin-bottom: 6px; display: inline-block; }
    input, select, button { width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid var(--border); background: #0b1222; color: var(--text); }
    input::placeholder { color: #6b7280; }
    button { background: #2563eb; border: none; cursor: pointer; font-weight: 600; }
    button:hover { filter: brightness(1.1); }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .status { margin-top: 10px; font-size: 13px; color: var(--muted); }
    .ok { color: var(--accent); }
    .err { color: var(--danger); }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border-bottom: 1px solid var(--border); padding: 10px; text-align: center; }
    th { background: #0b1222; font-weight: 600; font-size: 13px; color: var(--muted); }
    tbody tr:nth-child(odd) { background: var(--table-alt); }
    .toolbar { display: flex; gap: 8px; align-items: center; justify-content: space-between; margin-top: 8px; }
    .kpis { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; }
    .kpi { background: #0b1222; border: 1px solid var(--border); border-radius: 10px; padding: 10px; text-align: center; }
    .kpi .label { font-size: 12px; color: var(--muted); }
    .kpi .val { font-size: 18px; font-weight: 700; margin-top: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>BTCUSD Trade Journal</h1>

    <div class="grid">
      <div class="card">
        <form id="tradeForm">
          <div class="row">
            <div>
              <label for="date">Trade date</label>
              <input type="date" id="date" required />
            </div>
            <div>
              <label for="setup">Setup</label>
              <input type="text" id="setup" placeholder="Breakout / Reversion / VWAP retest" required />
            </div>
          </div>
          <div class="row3" style="margin-top:12px;">
            <div>
              <label for="entry">Entry</label>
              <input type="number" id="entry" step="0.01" placeholder="e.g. 67450.00" required />
            </div>
            <div>
              <label for="exit">Exit</label>
              <input type="number" id="exit" step="0.01" placeholder="e.g. 67820.00" required />
            </div>
            <div>
              <label for="result">Result</label>
              <select id="result" required>
                <option value="">Select</option>
                <option value="Win">Win</option>
                <option value="Loss">Loss</option>
              </select>
            </div>
          </div>
          <div style="margin-top:12px;">
            <button type="submit">Add trade</button>
          </div>
          <div id="status" class="status"></div>
        </form>
      </div>

      <div class="card">
        <div class="toolbar">
          <div class="status" id="loadStatus">Loading trades...</div>
          <div style="display:flex; gap:8px;">
            <button id="refreshBtn" type="button">Refresh</button>
            <button id="exportBtn" type="button">Export CSV</button>
          </div>
        </div>
        <div class="kpis">
          <div class="kpi">
            <div class="label">Total trades</div>
            <div class="val" id="kpiTotal">0</div>
          </div>
          <div class="kpi">
            <div class="label">Win rate</div>
            <div class="val" id="kpiWinRate">0%</div>
          </div>
          <div class="kpi">
            <div class="label">Avg win</div>
            <div class="val" id="kpiAvgWin">0</div>
          </div>
          <div class="kpi">
            <div class="label">Avg loss</div>
            <div class="val" id="kpiAvgLoss">0</div>
          </div>
        </div>
        <table id="journalTable">
          <thead>
            <tr>
              <th>Date</th>
              <th>Setup</th>
              <th>Entry</th>
              <th>Exit</th>
              <th>Result</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Supabase credentials (replace with yours â€” already provided)
    const SUPABASE_URL = "https://dgvvaxdzzbgjllfxmmrz.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRndnZheGR6emJnamxsZnhtbXJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3ODAzNTcsImV4cCI6MjA3ODM1NjM1N30.pegoF2QFHc8LfIkRXWvQGLvNKzWLH8TK17T7SoJmmlY";

    // REST endpoint for the trades table
    const TRADES_URL = `${SUPABASE_URL}/rest/v1/trades`;

    // Common headers for Supabase REST
    const headers = {
      "Content-Type": "application/json",
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
      "Prefer": "return=representation"
    };

    const form = document.getElementById("tradeForm");
    const statusEl = document.getElementById("status");
    const loadStatusEl = document.getElementById("loadStatus");
    const tableBody = document.querySelector("#journalTable tbody");
    const refreshBtn = document.getElementById("refreshBtn");
    const exportBtn = document.getElementById("exportBtn");

    const kpiTotal = document.getElementById("kpiTotal");
    const kpiWinRate = document.getElementById("kpiWinRate");
    const kpiAvgWin = document.getElementById("kpiAvgWin");
    const kpiAvgLoss = document.getElementById("kpiAvgLoss");

    function fmtNum(n) {
      if (n === null || n === undefined || Number.isNaN(n)) return "-";
      return Number(n).toFixed(2);
    }

    function computeKpis(rows) {
      const total = rows.length;
      const wins = rows.filter(r => r.result === "Win");
      const losses = rows.filter(r => r.result === "Loss");
      const winRate = total ? (wins.length / total) * 100 : 0;

      const winDiffs = wins.map(r => Number(r.exit) - Number(r.entry));
      const lossDiffs = losses.map(r => Number(r.exit) - Number(r.entry));

      const avg = arr => arr.length ? arr.reduce((a,b)=>a+b,0) / arr.length : 0;

      kpiTotal.textContent = total;
      kpiWinRate.textContent = `${winRate.toFixed(0)}%`;
      kpiAvgWin.textContent = fmtNum(avg(winDiffs));
      kpiAvgLoss.textContent = fmtNum(avg(lossDiffs));
    }

    async function loadTrades() {
      loadStatusEl.textContent = "Loading trades...";
      tableBody.innerHTML = "";
      try {
        const res = await fetch(`${TRADES_URL}?select=*&order=inserted_at.desc`, { headers });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const rows = await res.json();

        if (!rows.length) {
          tableBody.innerHTML = `<tr><td colspan="5" style="color:#9ca3af;">No trades yet</td></tr>`;
        } else {
          rows.forEach(row => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
              <td>${row.trade_date}</td>
              <td>${row.setup}</td>
              <td>${fmtNum(row.entry)}</td>
              <td>${fmtNum(row.exit)}</td>
              <td>${row.result}</td>
            `;
            tableBody.appendChild(tr);
          });
        }
        computeKpis(rows);
        loadStatusEl.textContent = `Loaded ${rows.length} trades.`;
      } catch (e) {
        console.error(e);
        loadStatusEl.textContent = "Error loading trades.";
        tableBody.innerHTML = `<tr><td colspan="5" style="color:#ef4444;">Failed to load trades</td></tr>`;
      }
    }

    async function addTrade(evt) {
      evt.preventDefault();
      statusEl.className = "status";
      statusEl.textContent = "Saving...";

      const payload = {
        trade_date: document.getElementById("date").value,
        setup: document.getElementById("setup").value.trim(),
        entry: parseFloat(document.getElementById("entry").value),
        exit: parseFloat(document.getElementById("exit").value),
        result: document.getElementById("result").value
      };

      // Basic validations
      if (!payload.trade_date || !payload.setup || !Number.isFinite(payload.entry) || !Number.isFinite(payload.exit) || !payload.result) {
        statusEl.className = "status err";
        statusEl.textContent = "Please complete all fields with valid values.";
        return;
      }

      try {
        const res = await fetch(TRADES_URL, {
          method: "POST",
          headers,
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        await res.json(); // return=representation
        statusEl.className = "status ok";
        statusEl.textContent = "Trade saved.";
        form.reset();
        await loadTrades();
      } catch (e) {
        console.error(e);
        statusEl.className = "status err";
        statusEl.textContent = "Error saving trade.";
      }
    }

    function exportCsv() {
      const rows = Array.from(tableBody.querySelectorAll("tr")).map(tr => Array.from(tr.children).map(td => td.textContent));
      const header = ["Date","Setup","Entry","Exit","Result"];
      const all = [header, ...rows].map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
      const blob = new Blob([all], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "trades.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    form.addEventListener("submit", addTrade);
    refreshBtn.addEventListener("click", loadTrades);
    exportBtn.addEventListener("click", exportCsv);

    // Initial load
    loadTrades();
  </script>
</body>
</html>
